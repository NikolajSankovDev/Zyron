// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  BARBER
  ADMIN
}

enum AppointmentStatus {
  BOOKED
  ARRIVED
  MISSED
  CANCELED
  COMPLETED
}

model User {
  id           String   @id @default(cuid())
  clerkUserId  String?  @unique // Links to Clerk user ID for authentication only
  role         UserRole @default(CUSTOMER)
  name         String   // Full name (canonical source)
  email        String   @unique // Canonical source
  phone        String   // Required - canonical source for barber contact
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  customerAppointments Appointment[] @relation("CustomerAppointments")
  barber              Barber?

  @@index([email])
  @@index([clerkUserId])
  @@map("users")
}

model Barber {
  id          String   @id @default(cuid())
  userId      String   @unique
  displayName String
  bio         String?
  languages   String[] // JSON array of locales: ["de", "ru", "en"]
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments      Appointment[]
  workingHours      BarberWorkingHours[]
  timeOff           BarberTimeOff[]

  @@map("barbers")
}

model Service {
  id             Int      @id @default(autoincrement())
  slug           String   @unique
  durationMinutes Int
  basePrice      Decimal  @db.Decimal(10, 2)
  active         Boolean  @default(true)
  order          Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  translations      ServiceTranslation[]
  appointmentServices AppointmentService[]

  @@map("services")
}

model ServiceTranslation {
  id          Int      @id @default(autoincrement())
  serviceId   Int
  locale      String   // "de" | "en" | "ru"
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, locale])
  @@map("service_translations")
}

model Appointment {
  id         String            @id @default(cuid())
  customerId String
  barberId   String
  startTime  DateTime
  endTime    DateTime
  status     AppointmentStatus @default(BOOKED)
  totalPrice Decimal           @db.Decimal(10, 2)
  notes      String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  // Relations
  customer         User                 @relation("CustomerAppointments", fields: [customerId], references: [id], onDelete: Cascade)
  barber           Barber               @relation(fields: [barberId], references: [id], onDelete: Cascade)
  appointmentServices AppointmentService[]

  @@unique([barberId, startTime]) // Prevent double bookings
  @@index([barberId, startTime])
  @@index([customerId])
  @@index([startTime])
  @@map("appointments")
}

model AppointmentService {
  id            String   @id @default(cuid())
  appointmentId String
  serviceId     Int
  priceOverride Decimal? @db.Decimal(10, 2)
  order         Int      @default(0)
  createdAt     DateTime @default(now())

  // Relations
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, serviceId, order])
  @@map("appointment_services")
}

model BarberWorkingHours {
  id                        Int      @id @default(autoincrement())
  barberId                  String
  weekday                   Int      // 0-6 (Sunday-Saturday)
  startTime                 String   // "09:00"
  endTime                   String   // "19:00"
  defaultSlotIntervalMinutes Int     @default(15)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  barber Barber @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@unique([barberId, weekday])
  @@map("barber_working_hours")
}

model BarberTimeOff {
  id          String    @id @default(cuid())
  barberId    String
  startDateTime DateTime
  endDateTime   DateTime
  reason      String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  barber Barber @relation(fields: [barberId], references: [id], onDelete: Cascade)

  @@index([barberId, startDateTime])
  @@map("barber_time_off")
}

